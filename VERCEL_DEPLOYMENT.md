# Vercel Deployment Guide

Complete guide to deploy Intentional Things Finder on Vercel with Postgres database.

## Step 1: Import Project to Vercel

1. Go to https://vercel.com/new
2. Click "Import Git Repository"
3. Select: `setosa-versicolor/intentional-things-finder`
4. **WAIT - Don't click Deploy yet!** Continue to Step 2 first.

## Step 2: Create Vercel Postgres Database

1. In your Vercel project dashboard, go to **Storage** tab
2. Click "Create Database"
3. Select **Postgres**
4. Name it: `intentional-things-db`
5. Choose your region (preferably US East or closest to you)
6. Click "Create"
7. Vercel will automatically add these environment variables to your project:
   - `POSTGRES_URL` - Pooled connection string (what we'll use)
   - `POSTGRES_URL_NON_POOLED` - Direct connection
   - And several others

## Step 3: Add Additional Environment Variables

In your Vercel project settings ‚Üí Environment Variables, add:

### Required:
- `CRON_SECRET` - Generate a random string (used to protect cron endpoint)
  - Example: `openssl rand -base64 32` or use https://randomkeygen.com/

### Optional (for embeddings):
- `OPENAI_API_KEY` - Your OpenAI API key (for vector embeddings)

## Step 4: Deploy the Project

1. Click "Deploy" in Vercel
2. Wait for build to complete (~2-3 minutes)
3. Vercel will give you a URL like: `https://your-project.vercel.app`

## Step 5: Run Database Migration

After deployment, you need to set up the database schema.

### Option A: Using Vercel CLI (Recommended)

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Link to your project
vercel link

# Pull environment variables
vercel env pull .env.local

# Run migration
node scripts/migrate-database.js

# Import events
node scripts/import-events.js
```

### Option B: Manual SQL Execution

1. Go to Vercel Dashboard ‚Üí Storage ‚Üí Your Postgres DB
2. Click "Query" tab
3. Copy contents of `migrations/001_initial_schema 2.sql`
4. Paste and execute
5. Copy contents of `migrations/002_seed_madison_places.sql`
6. Paste and execute
7. Run the import script locally:
   ```bash
   POSTGRES_URL="your-vercel-postgres-url" node scripts/import-events.js
   ```

## Step 6: Verify Everything Works

### Test API Endpoints:
```bash
# Health check
curl https://your-project.vercel.app/api/health

# Stats
curl https://your-project.vercel.app/api/stats

# Recommendations
curl -X POST https://your-project.vercel.app/api/recommendations \
  -H "Content-Type: application/json" \
  -d '{"timeAvailable":120,"quietSocial":0.5,"insideOutside":0.5,"kidFriendly":false,"lowEnergy":false}'
```

### Test Frontend:
Visit `https://your-project.vercel.app` and try the recommendation flow.

## Step 7: Enable Cron Job (Daily Event Scraping)

Vercel automatically sets up cron jobs defined in `vercel.json`.

The scraper runs daily at 6am UTC (12am/1am Central).

### Manual Trigger (for testing):
```bash
curl -X POST https://your-project.vercel.app/api/cron/scrape-events \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

Replace `YOUR_CRON_SECRET` with the value you set in environment variables.

## Architecture Overview

### Frontend (Vite + React)
- Deployed as static site
- Automatically built from `/src`
- Uses API routes on same domain

### API (Serverless Functions)
- `/api/health.js` - Health check
- `/api/recommendations.js` - Get personalized recommendations
- `/api/stats.js` - Database statistics
- `/api/feedback.js` - User feedback
- `/api/cron/scrape-events.js` - Daily event scraping

### Database (Neon Postgres via Vercel)
- Fully managed PostgreSQL
- Automatic connection pooling
- pgvector support for embeddings
- Daily backups

### Scheduled Tasks (Vercel Cron)
- Daily scraping at 6am UTC
- Automatically imports ~100 events from Isthmus
- Protected by CRON_SECRET

## Environment Variables Summary

### Auto-generated by Vercel:
- `POSTGRES_URL` ‚úì (from Vercel Postgres)
- `POSTGRES_URL_NON_POOLED` ‚úì
- `POSTGRES_PRISMA_URL` ‚úì
- `POSTGRES_URL_NO_SSL` ‚úì
- `POSTGRES_USER` ‚úì
- `POSTGRES_HOST` ‚úì
- `POSTGRES_PASSWORD` ‚úì
- `POSTGRES_DATABASE` ‚úì

### You need to add:
- `CRON_SECRET` ‚ùó Required for cron jobs
- `OPENAI_API_KEY` ‚ö†Ô∏è Optional (for embeddings)

## Troubleshooting

### "Database not connected" error
- Check that Vercel Postgres is created and linked
- Verify `POSTGRES_URL` environment variable exists
- Try redeploying

### "Unauthorized" on cron endpoint
- Check `CRON_SECRET` environment variable is set
- Make sure you're using `Bearer` token in Authorization header

### No events in database
- Run the migration scripts (Step 5)
- Manually trigger the cron job (Step 7)
- Check Vercel function logs for errors

### Frontend can't reach API
- Check that API endpoints are deployed (`/api/*.js` files)
- Verify frontend is using relative URLs in production
- Check browser console for CORS errors

## Monitoring

### View Logs:
1. Go to Vercel Dashboard
2. Click on your deployment
3. Go to "Functions" tab
4. Click on any function to see logs

### Database Stats:
Visit `/api/stats` to see:
- Number of places
- Number of events
- Events by source
- Upcoming events by week

## Cost Estimates

### Vercel
- **Hobby Plan (Free):**
  - Serverless Functions: 100GB-hrs/month
  - Bandwidth: 100GB/month
  - Builds: 6,000 minutes/month
  - Good for MVP and testing

- **Pro Plan ($20/month):**
  - More function executions
  - Better performance
  - Team features

### Vercel Postgres (powered by Neon)
- **Free Tier:**
  - 0.5GB storage
  - 10 hours compute/month
  - Good for testing

- **Paid:**
  - Starts at $20/month
  - More storage and compute

## Next Steps

1. ‚úÖ Deploy to Vercel
2. ‚úÖ Set up database
3. ‚úÖ Import events
4. ‚úÖ Test everything
5. üöÄ Share with users!

## Support

- Vercel Docs: https://vercel.com/docs
- Vercel Postgres Docs: https://vercel.com/docs/storage/vercel-postgres
- Vercel Cron Jobs: https://vercel.com/docs/cron-jobs
